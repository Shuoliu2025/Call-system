<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªåŠ¨å«å·ç³»ç»Ÿ - å†å²è®°å½•</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸš— è‡ªåŠ¨å«å·ç³»ç»Ÿ</h1>
            <nav>
                <a href="index.html" class="nav-link">é¢„çº¦ç™»è®°</a>
                <a href="display.html" class="nav-link">å«å·æ˜¾ç¤º</a>
                <a href="history.html" class="nav-link active">å†å²è®°å½•</a>
            </nav>
        </header>

        <main>
            <div class="history-section">
                <div class="section-header">
                    <h2>ğŸ“Š ä»Šæ—¥è®°å½•</h2>
                    <button id="refreshHistory" class="refresh-btn">ğŸ”„ åˆ·æ–°</button>
                </div>

                <div class="history-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalAppointments">0</div>
                        <div class="stat-label">æ€»é¢„çº¦</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completedOutbound">0</div>
                        <div class="stat-label">å·²å‡ºåº“</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pendingAppointments">0</div>
                        <div class="stat-label">ç­‰å¾…ä¸­</div>
                    </div>
                </div>

                <div class="history-table">
                    <table id="historyTable">
                        <thead>
                            <tr>
                                <th>æ—¶é—´</th>
                                <th>å§“å</th>
                                <th>æ‰‹æœºå·</th>
                                <th>è½¦ç‰Œå·</th>
                                <th>çŠ¶æ€</th>
                                <th>å‡ºåº“æ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>

                <div class="no-history" id="noHistory" style="display: none;">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“‹</div>
                        <h3>æš‚æ— å†å²è®°å½•</h3>
                        <p>ä»Šæ—¥è¿˜æ²¡æœ‰é¢„çº¦è®°å½•</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        function loadHistory() {
            Promise.all([
                fetch('/api/history').then(r => r.json()),
                fetch('/api/appointments').then(r => r.json())
            ])
            .then(([history, appointments]) => {
                updateStats(history, appointments);
                updateTable(history);
            })
            .catch(error => {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
            });
        }

        function updateStats(history, appointments) {
            const totalAppointments = appointments.appointments.length + history.length;
            const completedOutbound = history.filter(h => h.action === 'outbound').length;
            const pendingAppointments = appointments.appointments.length;

            document.getElementById('totalAppointments').textContent = totalAppointments;
            document.getElementById('completedOutbound').textContent = completedOutbound;
            document.getElementById('pendingAppointments').textContent = pendingAppointments;
        }

        function updateTable(history) {
            const tbody = document.getElementById('historyBody');
            const noHistory = document.getElementById('noHistory');
            const table = document.querySelector('.history-table');

            if (history.length === 0) {
                table.style.display = 'none';
                noHistory.style.display = 'block';
                return;
            }

            table.style.display = 'block';
            noHistory.style.display = 'none';

            tbody.innerHTML = history
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .map(record => {
                    const appointmentTime = new Date(record.timestamp).toLocaleString('zh-CN');
                    const outboundTime = record.outboundTime ?
                        new Date(record.outboundTime).toLocaleString('zh-CN') : '-';

                    const status = record.action === 'outbound' ? 'å·²å‡ºåº“' : 'å·²é¢„çº¦';
                    const statusClass = record.action === 'outbound' ? 'status-completed' : 'status-pending';

                    return `
                        <tr>
                            <td>${appointmentTime}</td>
                            <td>${record.name}</td>
                            <td>${record.phone}</td>
                            <td class="license-plate">${record.licensePlate}</td>
                            <td><span class="status-badge ${statusClass}">${status}</span></td>
                            <td>${outboundTime}</td>
                        </tr>
                    `;
                })
                .join('');
        }

        function showMessage(text, type = 'success') {
            const popup = document.createElement('div');
            popup.className = `message-toast ${type}`;
            popup.textContent = text;
            document.body.appendChild(popup);

            setTimeout(() => {
                popup.classList.add('show');
            }, 100);

            setTimeout(() => {
                popup.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(popup);
                }, 300);
            }, 3000);
        }

        document.getElementById('refreshHistory').addEventListener('click', () => {
            loadHistory();
            showMessage('å†å²è®°å½•å·²åˆ·æ–°');
        });

        loadHistory();
    </script>
</body>
</html>